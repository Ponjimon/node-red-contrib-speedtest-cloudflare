var e=require("https"),t=require("perf_hooks");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=r(e),s=(e,t)=>{e.sort(((e,t)=>e-t));var r=(e.length-1)*t,a=Math.floor(r);return void 0!==e[a+1]?e[a]+(r-a)*(e[a+1]-e[a]):e[a]};class o{host="speed.cloudflare.com";async start(){var e=await Promise.all([[1e5,10],[1e6,8],[1e7,6],[25e6,4],[1e8,3]].map((([e,t])=>this.measureDownload(e,t)))),t=s(e.flat(),.9).toFixed(2),r=(await Promise.all([[1e5,8],[1e6,6],[1e7,4]].map((([e,t])=>this.measureUpload(e,t))))).flat();return{download:t,upload:s(r,.9).toFixed(2)}}async measureDownload(e,t){for(var r=[],a=0;a<t;a++)try{var{ttfb:s,ended:o}=await this.download(e);r.push(this.measureSpeed(e,o-s))}catch(e){throw e}return r}async measureUpload(e,t){for(var r=[],a=0;a<t;a++)try{var{serverDuration:s}=await this.upload(e);r.push(this.measureSpeed(e,s))}catch(e){throw e}return r}download(e){return this.request({hostname:this.host,path:`/__down?bytes=${e}`,method:"GET"})}upload(e){var t="0".repeat(e);return this.request({hostname:this.host,path:"/__up",method:"POST",headers:{"Content-Length":Buffer.byteLength(t)}},t)}measureSpeed(e,t){return 8*e/(t/1e3)/1e6}request(e,r=""){var s,o,n,h,i,d;return new Promise(((u,l)=>{s=t.performance.now();var c=a.default.request(e,(e=>{e.once("readable",(()=>{i=t.performance.now()})),e.on("data",(()=>{})),e.on("end",(()=>{d=t.performance.now(),u({started:s,dnsLookup:o,tcpHandshake:n,sslHandshake:h,ttfb:i,ended:d,serverDuration:parseFloat(String(e.headers["server-timing"]).slice(22))})}))}));c.on("socket",(e=>{e.on("lookup",(()=>{o=t.performance.now()})),e.on("connect",(()=>{n=t.performance.now()})),e.on("secureConnect",(()=>{h=t.performance.now()}))})),c.on("error",(e=>{l(e)})),c.write(r),c.end()}))}}module.exports=e=>{e.nodes.registerType("speedtest-cloudflare",(function(t){e.nodes.createNode(this,t),this.on("input",(async(e,t,r)=>{this.status({fill:"yellow",shape:"dot",text:"Requesting"});var a=new o;try{var s=await a.start();this.status({}),this.send({payload:s})}catch(e){this.status({fill:"red",shape:"dot",text:e.message})}}))}))};
//# sourceMappingURL=index.js.map
