import t from"https";import{performance as e}from"perf_hooks";var r=(t,e)=>{t.sort(((t,e)=>t-e));var r=(t.length-1)*e,a=Math.floor(r);return void 0!==t[a+1]?t[a]+(r-a)*(t[a+1]-t[a]):t[a]};class a{host="speed.cloudflare.com";async start(){var t=await Promise.all([[1e5,10],[1e6,8],[1e7,6],[25e6,4],[1e8,3]].map((([t,e])=>this.measureDownload(t,e)))),e=r(t.flat(),.9).toFixed(2),a=(await Promise.all([[1e5,8],[1e6,6],[1e7,4]].map((([t,e])=>this.measureUpload(t,e))))).flat();return{download:e,upload:r(a,.9).toFixed(2)}}async measureDownload(t,e){for(var r=[],a=0;a<e;a++)try{var{ttfb:s,ended:o}=await this.download(t);r.push(this.measureSpeed(t,o-s))}catch(t){throw t}return r}async measureUpload(t,e){for(var r=[],a=0;a<e;a++)try{var{serverDuration:s}=await this.upload(t);r.push(this.measureSpeed(t,s))}catch(t){throw t}return r}download(t){return this.request({hostname:this.host,path:`/__down?bytes=${t}`,method:"GET"})}upload(t){var e="0".repeat(t);return this.request({hostname:this.host,path:"/__up",method:"POST",headers:{"Content-Length":Buffer.byteLength(e)}},e)}measureSpeed(t,e){return 8*t/(e/1e3)/1e6}request(r,a=""){var s,o,n,h,i,d;return new Promise(((u,l)=>{s=e.now();var p=t.request(r,(t=>{t.once("readable",(()=>{i=e.now()})),t.on("data",(()=>{})),t.on("end",(()=>{d=e.now(),u({started:s,dnsLookup:o,tcpHandshake:n,sslHandshake:h,ttfb:i,ended:d,serverDuration:parseFloat(String(t.headers["server-timing"]).slice(22))})}))}));p.on("socket",(t=>{t.on("lookup",(()=>{o=e.now()})),t.on("connect",(()=>{n=e.now()})),t.on("secureConnect",(()=>{h=e.now()}))})),p.on("error",(t=>{l(t)})),p.write(a),p.end()}))}}export default t=>{t.nodes.registerType("speedtest-cloudflare",(function(e){t.nodes.createNode(this,e),this.on("input",(async(t,e,r)=>{this.status({fill:"yellow",shape:"dot",text:"Requesting"});var s=new a;try{var o=await s.start();this.status({}),this.send({payload:o})}catch(t){this.status({fill:"red",shape:"dot",text:t.message})}}))}))};
//# sourceMappingURL=index.esm.js.map
